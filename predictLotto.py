#!/usr/bin/env python3

import signal
import atexit
import errno
import json
import sys
import os
import socket
import argparse
from libraries.daemon import Daemon
from libraries.signalHandler import SignalHandler
from libraries.socket import ServerSocket, ClientSocket
from libraries.ticket import Lottario, LottoMax, LottoSixFortyNine, LottoTicket, QuickPick, PickYourOwn

switchParser = argparse.ArgumentParser(
    description="Welcome to your Lotto Ticket Predictor!")

# Ticket type selection
group = switchParser.add_mutually_exclusive_group(required=True)
group.add_argument(
    '-sixfournine',
    help="Generates a Lotto 649 ticket prediction. If used with -pick select 6 numbers to play",
    action='store_true')
group.add_argument(
    '-lottario',
    help="Generates a Lottario ticket prediction. If used with -pick select 6 numbers to play",
    action='store_true')
group.add_argument(
    '-lottomax',
    help="Generates a LottoMax ticket prediction. If used with -pick select 7 numbers to play",
    action='store_true')

# Quick Pick Switch
switchParser.add_argument(
    '-quick',
    help="Quick Pick will generate you a quick pick lotto ticket prediction with randomly selected numbers.",
    required=False,
    action='store_true')
# Pick Your Own Switch
switchParser.add_argument(
    '-pick',
    help="Pick Your Own will generate you a pick your own ticket prediction, with numbers you picked! (6 or 7 numbers depending on your ticket type)",
    required=False,
    nargs='+')

switchParser.add_argument(
    '-encore',
    help="Encore will be added to your ticket prediction to win more!",
    required=False,
    action='store_true')

args = switchParser.parse_args()

def runDaemon(ip, port, queueSize):
    concurrencyManager = SignalHandler()
    socketManager = ClientSocket(ip, port)


if __name__ == "__main__":

    try:
        if(args.pick):
            totalNumbers = len(args.pick)
        else:
            totalNumbers = -1

        if(args.sixfournine):
            if(totalNumbers != 6 and totalNumbers != -1):
                raise ValueError(
                    "You picked {0} numbers. Please pick six numbers for your Lotto 649 Ticket".format(totalNumbers))
            baseTicket = LottoSixFortyNine()

        elif(args.lottario):
            if(totalNumbers != 6 and totalNumbers != -1):
                raise ValueError(
                    "You picked {0} numbers. Please pick six numbers for your Lottario Ticket".format(totalNumbers))
            baseTicket = Lottario()

        elif(args.lottomax):
            if(totalNumbers != 7 and totalNumbers != -1):
                raise ValueError(
                    "You picked {0} numbers. Please pick seven numbers for your LottoMax Ticket".format(totalNumbers))
            baseTicket = LottoMax()

        if(args.quick):
            if(args.encore):
                ticket = QuickPick(True, baseTicket)
            else:
                ticket = QuickPick(False, baseTicket)
        elif(args.pick):
            argsAsInt = []

            try:
                argsAsInt = list(map(int, args.pick))
            except ValueError as ex:
                raise ValueError(
                    "Invalid value inserted, please insert only numbers")

            if(args.encore):
                ticket = PickYourOwn(argsAsInt, True, baseTicket)
            else:
                ticket = PickYourOwn(argsAsInt, False, baseTicket)
        elif(args.encore):
            raise AttributeError(
                "The encore argument must be used with a Quick Pick or a Pick Your Own ticket")
        else:
            raise AttributeError(
                "None or invalid arguments given, ticket not generated! Please pick a ticket mode, either Quick Pick or Pick Your Own Ticket. Use the -h switch if required.")

        ticket.printTicket()

        hostIp = "::1"
        hostPort = 4200
        daemon = Daemon()
        daemon.startDaemon()
        runDaemon(hostIp, hostPort, 5)
    except ValueError as ex:
        daemon = Daemon()
        daemon.stopDaemon()
        print(ex)
    except AttributeError as ex:
        daemon = Daemon()
        daemon.stopDaemon()
        print(ex)
#!/usr/bin/env python3

import signal
import atexit
import errno
import json
import sys
import os
import socket
import argparse
from libraries.daemon import Daemon
from libraries.signalHandler import SignalHandler
from libraries.socket import ServerSocket, ClientSocket


switchParser = argparse.ArgumentParser(
    description="Welcome to your malware!")

group = switchParser.add_mutually_exclusive_group(required=True)
# Stop daemon switch
group.add_argument(
    '-stop',
    help="Stops running the daemon",
    required=False,
    action='store_true')

# Start daemon switch
group.add_argument(
    '-start',
    help="Starts the daemon",
    required=False,
    default=True,
    action='store_true')

args = switchParser.parse_args()

def runDaemon(port, queueSize):
    concurrencyManager = SignalHandler()
    socketManager = ClientSocket("::1", port)
    hostname = socket.gethostname()
    ip_address = socket.gethostbyname(hostname)
    while True:
        try:
            socketManager.sendData(ip_address)
        except IOError as err:
            code, msg = err.args
            if code == errno.EINTR:
                continue
            else:
                raise


if __name__ == "__main__":
    if(args.stop):
        daemon = Daemon()
        daemon.stopDaemon()
    elif(args.start):
        daemon = Daemon()
        daemon.startDaemon()
        runDaemon(4200, 5)
    else:
        print("Please select an option: -start or -stop for the Daemon")
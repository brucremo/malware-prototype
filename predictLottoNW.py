#!/usr/bin/env python3

import logzero
import signal
import atexit
import errno
import json
import sys
import os
from socket import *
from logzero import logger

from libraries.daemonizeNW import *
from libraries.socket import ServerSocket
from libraries.signalHandler import SignalHandler


def main():

    port = 8080
    numberOfClients = 1000

    listener = ServerSocket(port, numberOfClients)

    signal.signal(signal.SIGCHLD, SignalHandler.childSignalHandler)

    while True:

        listener.acceptConnections()
        listener.startLogic()


if __name__ == "__main__":

    PIDFILE = "/tmp/daemon.pid"
    logzero.logfile(
        "/tmp/rotating-logfile.log",
        maxBytes=1e6,
        backupCount=3,
        disableStderrLogger=True)

    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} [start|stop]", file=sys.stderr)
        raise SystemExit(1)

    if sys.argv[1] == "start":
        try:
            daemonize(
                PIDFILE,
                stdout="/tmp/daemon.log",
                stderr="/tmp/dameon.log")

        except RuntimeError as e:
            print(e, file=sys.stderr)
            raise SystemExit(1)

        logger.info(f"Started {os.getpid()}")
        main()

    elif sys.argv[1] == "stop":
        if os.path.exists(PIDFILE):
            with open(PIDFILE) as f:
                os.kill(int(f.read()), signal.SIGTERM)
        else:
            print("Not  running", file=sys.stderr)
            raise SystemExit(1)
    else:
        print(f"Unknown  command  {sys.argv[1] !r}", file=sys.stderr)
        raise SystemExit(1)
